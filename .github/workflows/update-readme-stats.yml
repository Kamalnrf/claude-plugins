# Updates README with current plugin/skill counts from the registry API
# Creates a PR for review

name: Update README Stats

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:      # Manual trigger for testing

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.README_STATS_TOKEN }}
          fetch-depth: 0

      - name: Fetch counts from API
        id: counts
        run: |
          # Function to add thousand separators (works on all platforms)
          add_commas() { echo $1 | rev | sed 's/.\{3\}/&,/g' | rev | sed 's/^,//'; }
          
          PLUGINS=$(curl -s 'https://claude-plugins.dev/api/plugins?limit=1' | jq '.total')
          SKILLS=$(curl -s 'https://claude-plugins.dev/api/skills?limit=1' | jq '.total')
          
          PLUGINS_FMT=$(add_commas $PLUGINS)
          SKILLS_FMT=$(add_commas $SKILLS)
          
          echo "plugins=$PLUGINS_FMT" >> $GITHUB_OUTPUT
          echo "skills=$SKILLS_FMT" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          sed -i -E "s/discovering [0-9,]+ Claude Code plugins and [0-9,]+ agent skills/discovering ${{ steps.counts.outputs.plugins }} Claude Code plugins and ${{ steps.counts.outputs.skills }} agent skills/" README.md

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.README_STATS_TOKEN }}
          commit-message: "[bot] Update README stats"
          branch: bot/update-readme-stats
          delete-branch: true
          title: "[Bot] Update README stats"
          body: |
            Automated update of README stats:
            - Plugins: ${{ steps.counts.outputs.plugins }}
            - Skills: ${{ steps.counts.outputs.skills }}
            
            This PR was automatically created by the Update README Stats workflow.
          labels: bot, documentation

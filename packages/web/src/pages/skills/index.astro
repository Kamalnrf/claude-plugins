---
import Badge from "@/components/Badge.astro";
import JsonLd from "@/components/JsonLd.astro";
import { MetaSkillHighlight } from "@/components/MetaSkillHighlight";
import { PluginOrSkillsTabSwitcher } from "@/components/PluginOrSkillsTabSwitcher";
import SkillBrowser from "@/components/SkillBrowser";
import MarketplaceLayout from "@/layouts/MarketplaceLayout.astro";
import { registryAPI } from "@/lib/api";

// Get search params from URL
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get("q")?.trim() || "";
const orderBy = url.searchParams.get("orderBy") as "downloads" | "stars" | null;
const order = url.searchParams.get("order") as "asc" | "desc" | null;

// Normalize URL: redirect empty query params to clean landing page for better cache consolidation
if (url.searchParams.has("q") && !searchQuery) {
	return Astro.redirect("/skills", 302);
}

// Fetch initial skills with SSR
const { skills, total } = await registryAPI.searchSkills({
	q: searchQuery,
	limit: 20,
	offset: 0,
	...(orderBy && { orderBy }),
	...(order && { order }),
});

// Cache all pages: 2h for landing, 10min for searches
const hasQueryParams = searchQuery || orderBy || order;
Astro.response.headers.set('Cache-Control',
	hasQueryParams
		? 'public, max-age=0, must-revalidate, s-maxage=600, stale-while-revalidate=1200'  // 10min for searches
		: 'public, max-age=0, must-revalidate, s-maxage=7200, stale-while-revalidate=14400' // 2h for landing
);
---

<MarketplaceLayout
  title="Discover Agent Skills"
  description={`Discover and install Agent Skills from across GitHub. Works with Claude, Cursor, OpenCode, Codex, and more. Auto-indexed, openâ€‘source, and communityâ€‘maintained. Search ${total}+ skills, track downloads, and quickly add capabilities to your AI coding assistant.`}
  ogImage="/api/og/skills-index.png"
>
  <Fragment slot="head">
    <JsonLd
      type="CollectionPage"
      name="Agent Skills Directory"
      description="Browse and install Agent Skills for Claude, Cursor, OpenCode, Codex, and more AI coding assistants"
      url="https://claude-plugins.dev/skills"
      breadcrumbs={[
        { name: "Home", url: "https://claude-plugins.dev" },
        { name: "Skills" }
      ]}
    />
  </Fragment>
  <div class="px-4 py-4 md:px-6 md:py-6 flex flex-col gap-6">
    <PluginOrSkillsTabSwitcher transition:persist client:load selectedTab="skills" />
    <section class="flex flex-col gap-5" transition:animate="fade" transition:name="hero">
      <div class="flex flex-col gap-2.5">
        <h1 class="text-2xl font-serif font-bold tracking-tight bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent">
          Discover Agent Skills
        </h1>
        <p class="text-base text-muted-foreground/80 leading-relaxed break-words">
          Discover and install <strong>Agent Skills</strong> for Claude, Cursor, OpenCode, Codex, and other AI coding assistants.
          Built on the open <a href="https://agentskills.io" class="underline hover:text-primary">agentskills</a> spec.
          All public skills on GitHub are auto-indexed and made available for quickly discovering and installing.
          <a href="https://github.com/Kamalnrf/claude-plugins" class="underline hover:text-primary">Open-source</a> and community-maintained.
        </p>
      </div>

      <!-- Built with badges -->
      <div class="flex items-center gap-2.5 text-xs text-muted-foreground/60">
        <span class="font-medium">built with</span>
        <div class="flex items-center gap-1.5">
          <Badge href="https://www.val.town/x/kamalnrf/claude-plugins-registry">Val Town</Badge>
          <Badge variant="dotted">Claude Code ðŸ˜‰</Badge>
        </div>
      </div>
    </section>

    <!-- Meta Skill Highlight -->
    <MetaSkillHighlight client:load />

    <SkillBrowser initialQuery={searchQuery} initialSkills={skills} total={total} initialOrderBy={orderBy} initialOrder={order} client:load />
  </div>
</MarketplaceLayout>

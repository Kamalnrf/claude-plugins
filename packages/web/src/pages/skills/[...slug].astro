---
import MarketplaceLayout from "../../layouts/MarketplaceLayout.astro";
import JsonLd from "../../components/JsonLd.astro";
import { registryAPI } from "../../lib/api";
import { InstallSkill } from "../../components/InstallSkill";
import { SkillDetailHeader } from "@/components/SkillDetailHeader";
import Markdown from "@/components/Markdown.astro";
import { Button } from "@/components/ui/button";
import {LinkIcon} from '@/components/ui/link-icon'

const { slug } = Astro.params;
const parts = slug?.split("/") || [];
if (parts.length !== 3) {
	return Astro.redirect("/404");
}

// Sanitize skillName to remove any file extensions like .md
const [owner, marketplace, skillNameRaw] = parts;
const skillName = skillNameRaw
const skill = await registryAPI.getSkill(owner, marketplace, skillName);
const markdown = await fetch(skill.metadata.rawFileUrl).then(res => res.text())

if (!skill) {
  return Astro.redirect("/404");
}

const pageTitle = `${skill.name} - Agent Skills`;
const pageDescription = skill.description || `Install and use ${skill.name} for Claude, Cursor, OpenCode, Codex, and more AI coding assistants`;
const ogImageUrl = `/api/og/skills/${slug}.png`;
const canonicalUrl = `https://claude-plugins.dev/skills/${slug}`;
const keywords = `Agent Skills, ${skill.name}, ${owner}, ${marketplace}, Claude, Claude Code, Cursor, VS Code, OpenCode, Amp Code, Codex, Letta, Goose, AI development tools, agentskills.io`;
const ogImageAlt = `${skill.name} - Agent skill for AI coding assistants with ${skill.stars} stars and ${skill.installs} installs`;

// ISR: Cache for 6 hours with 12 hour stale-while-revalidate
Astro.response.headers.set('Cache-Control', 'public, s-maxage=21600, stale-while-revalidate=43200');
---

<MarketplaceLayout
	title={pageTitle}
	description={pageDescription}
	ogImage={ogImageUrl}
	keywords={keywords}
	canonicalUrl={canonicalUrl}
>
	<Fragment slot="head">
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:image:alt" content={ogImageAlt} />
		<meta property="article:author" content={skill.author} />
		<meta property="article:published_time" content={skill.createdAt} />
		<meta property="article:modified_time" content={skill.updatedAt} />
		<JsonLd
			type="WebPage"
			name={skill.name}
			description={skill.description || `${skill.name} - Agent skill for AI coding assistants`}
			url={`https://claude-plugins.dev/skills/${slug}`}
			breadcrumbs={[
				{ name: "Home", url: "https://claude-plugins.dev" },
				{ name: "Skills", url: "https://claude-plugins.dev/skills" },
				{ name: skill.name }
			]}
		/>
	</Fragment>
	<div class="flex flex-col p-6 gap-4">
	  <SkillDetailHeader client:load skill={skill} />
		<section>
      <div class="flex items-center gap-2 py-2">
        <h2 class="text-base font-semibold text-foreground/90 tracking-tight">Install Skill</h2>
        <div class="flex-1 h-px bg-border/30"></div>
      </div>
			<InstallSkill skill={skill} client:load />
		</section>
		<section>
		  <div class="flex items-center gap-2 py-2">
        <h2 class="text-base font-semibold text-foreground/90 tracking-tight">SKILL.md</h2>
        <div class="flex-1 h-px bg-border/30"></div>
        <a href={skill.sourceUrl}>
          <Button variant="ghost" size="sm" className="cursor-pointer text-muted-foreground">View Source <LinkIcon /></Button>
        </a>
      </div>
		  <Markdown content={markdown} sourceUrl={skill.sourceUrl} />
		</section>
	</div>
</MarketplaceLayout>

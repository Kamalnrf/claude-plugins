---
import MarketplaceLayout from '../layouts/MarketplaceLayout.astro';
import { registryAPI } from '../lib/api';
import InfinitePluginList from '../components/InfinitePluginList';
import { Input } from '@/components/ui/input';
import { Search } from 'lucide-react';

// Get search params from URL
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';

// Fetch initial plugins with SSR
const { plugins, total } = await registryAPI.searchPlugins({
  q: searchQuery,
  limit: 20,
  offset: 0,
});

// Format number helper
function formatNumber(num: number): string {
  if (num < 1000) return num.toString();
  if (num < 10000) return num.toLocaleString('en-US');
  if (num < 1000000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
  return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
}
---

<MarketplaceLayout
  title="Claude Code Plugins - Marketplace & CLI Plugin Manager"
  description="Install Claude Code plugins directly without manually adding marketplaces first. Simple CLI tool that handles marketplace setup automatically. Browse and install from indexed public plugins."
>
  <div class="px-6 py-6 flex flex-col gap-6">
    <!-- Hero Section -->
    <section class="flex flex-col gap-5">
      <div class="flex flex-col gap-2.5">
        <h1 class="text-2xl font-serif font-bold tracking-tight bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent">
          Manage Claude Code plugins with ease
        </h1>
        <p class="text-base text-muted-foreground/80 leading-relaxed">
          Install <strong>Claude Code plugins</strong> directly without manually adding marketplaces first.
          Claude Code normally requires installing a marketplace, then installing plugins from it. This CLI handles both steps automatically in one command.
          Browse and install from <a href="https://www.val.town/x/kamalnrf/claude-plugins-registry" class="underline hover:text-primary">indexed public plugins</a>.
          <a href="https://github.com/Kamalnrf/claude-plugins" class="underline hover:text-primary">Open-source</a> and community-maintained.
        </p>
      </div>

      <!-- Built with badges -->
      <div class="flex items-center gap-2.5 text-xs text-muted-foreground/60">
        <span class="font-medium">built with</span>
        <div class="flex items-center gap-1.5">
          <span class="px-2 py-0.5 bg-muted/30 rounded border border-border/30 font-mono">bun</span>
          <a href="https://www.val.town/x/kamalnrf/claude-plugins-registry" class="px-2 py-0.5 bg-muted/30 rounded border border-border/30 font-mono hover:underline">Val Town</a>
          <span class="px-2 py-0.5 bg-muted/30 rounded border border-border/30 font-mono">Claude Code ðŸ˜‰</span>
        </div>
      </div>

      <!-- CLI Installation -->
      <section class="flex flex-col gap-2.5">
        <div class="flex items-center gap-2">
          <h2 class="text-base font-semibold text-foreground/90 tracking-tight">Quick Start</h2>
          <div class="flex-1 h-px bg-border/30"></div>
        </div>

        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">Install a plugin from the marketplace:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90">npx claude-plugins install {"<unique-plugin-identifier>"}</code>
          </div>
        </div>

        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">List all installed plugins:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90">npx claude-plugins list</code>
          </div>
        </div>

        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">Enable or Disable:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90">npx claude-plugins enable {"<plugin-name>"}</code>
          </div>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90">npx claude-plugins disable {"<plugin-name>"}</code>
          </div>
        </div>

        <!-- Install Globally and use without npx -->
        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">Install Globally and use without npx:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90">npm install -g claude-plugins</code>
          </div>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90">claude-plugins enable {"<plugin-name>"}</code>
          </div>
        </div>

        <p class="text-xs text-muted-foreground/60 mt-1">
          Requires Claude Code v2.0.12 or higher.
          <a href="https://github.com/Kamalnrf/claude-plugins" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
            Learn more â†’
          </a>
        </p>
      </section>
    </section>

    <!-- Search Section -->
    <section class="flex flex-col gap-3 sticky top-0 z-10 backdrop-blur-md bg-background/80">
      <div class="flex items-center gap-2">
        <h2 class="text-base font-semibold text-foreground/90 tracking-tight">Browse Plugins</h2>
        <div class="flex-1 h-px bg-border/30"></div>
        <div class="text-xs font-medium text-muted-foreground/70 tabular-nums px-2.5 py-1 bg-muted/30 rounded-full border border-border/30">
          {formatNumber(total)} {total === 1 ? 'plugin' : 'plugins'}
        </div>
      </div>

      <form method="get" class="sticky top-0 z-10" aria-label="Search plugins">
        <div class="relative group">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none" />
          <Input
            type="search"
            name="q"
            value={searchQuery}
            placeholder="Search by name, author, or keyword..."
            aria-label="Search for Claude Code plugins"
            className="h-9 pl-9 text-sm bg-background/50 backdrop-blur-sm border-border/50 focus:border-primary/50 focus:ring-2 focus:ring-primary/10 transition-all"
          />
        </div>
      </form>
    </section>

    <!-- Plugin List with Infinite Scroll -->
    <InfinitePluginList
      initialPlugins={plugins}
      searchQuery={searchQuery}
      total={total}
      client:load
    />
  </div>
</MarketplaceLayout>

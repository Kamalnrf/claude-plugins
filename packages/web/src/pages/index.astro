---
import { PluginOrSkillsTabSwitcher } from "@/components/PluginOrSkillsTabSwitcher";
import Badge from "../components/Badge.astro";
import PluginBrowser from "../components/PluginBrowser";
import MarketplaceLayout from "../layouts/MarketplaceLayout.astro";
import { registryAPI } from "../lib/api";

// Get search params from URL
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get("q") || "";
const hasSkills = url.searchParams.get("hasSkills") === "true";
const orderBy = url.searchParams.get("orderBy") as "downloads" | "stars" | null;
const order = url.searchParams.get("order") as "asc" | "desc" | null;

// Fetch initial plugins with SSR
const { plugins, total } = await registryAPI.searchPlugins({
	q: searchQuery,
	limit: 20,
	offset: 0,
	hasSkills,
	...(orderBy && { orderBy }),
	...(order && { order }),
});
---

<MarketplaceLayout
  title="Claude Code Plugins - Marketplace & CLI Plugin Manager"
  description="Install Claude Code plugins directly without manually adding marketplaces first. Simple CLI tool that handles marketplace setup automatically. Browse and install from indexed public plugins."
>
  <div class="p-4 md:p-6 flex flex-col gap-6">
    <PluginOrSkillsTabSwitcher transition:persist client:load selectedTab="plugins" />
    <!-- Hero Section -->
    <section class="flex flex-col gap-5" transition:animate="fade" transition:name="hero">
      <div class="flex flex-col gap-2.5">
        <h1 class="text-2xl font-serif font-bold tracking-tight bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent">
          Manage Claude Code plugins with ease
        </h1>
        <p class="text-base text-muted-foreground/80 leading-relaxed break-words">
          Discover and Install <strong>Claude Code plugins</strong>, even ones with <a href="https://www.anthropic.com/news/skills" class="underline"> skills</a> quickly.
          Claude Code normally requires installing a marketplace, then installing plugins from it. This CLI handles both steps automatically in one command.
          Browse plugins with skills to extend Claude's capabilitiesâ€”discover AI agents, document processors, and more.
          <a href="https://github.com/Kamalnrf/claude-plugins" class="underline hover:text-primary">Open-source</a> and community-maintained.
        </p>
      </div>

      <!-- Built with badges -->
      <div class="flex items-center gap-2.5 text-xs text-muted-foreground/60">
        <span class="font-medium">built with</span>
        <div class="flex items-center gap-1.5">
          <Badge>bun</Badge>
          <Badge href="https://www.val.town/x/kamalnrf/claude-plugins-registry">Val Town</Badge>
          <Badge variant="dotted">Claude Code ðŸ˜‰</Badge>
        </div>
      </div>

      <!-- CLI Installation -->
      <section class="flex flex-col gap-2.5">
        <div class="flex items-center gap-2">
          <h2 class="text-base font-semibold text-foreground/90 tracking-tight">Quick Start</h2>
          <div class="flex-1 h-px bg-border/30"></div>
        </div>

        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">Install a plugin from the marketplace:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs overflow-x-auto">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90 whitespace-nowrap">npx claude-plugins install {"<unique-plugin-identifier>"}</code>
          </div>
        </div>

        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">List all installed plugins:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs overflow-x-auto">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90 whitespace-nowrap">npx claude-plugins list</code>
          </div>
        </div>

        <div class="flex flex-col gap-1.5">
          <p class="text-xs text-muted-foreground">Enable or Disable:</p>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs overflow-x-auto">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90 whitespace-nowrap">npx claude-plugins enable {"<plugin-name>"}</code>
          </div>
          <div class="flex items-center gap-2 bg-muted/30 border border-border/50 rounded-lg px-3 py-2 font-mono text-xs overflow-x-auto">
            <span class="select-none text-muted-foreground/50">$</span>
            <code class="flex-1 text-foreground/90 whitespace-nowrap">npx claude-plugins disable {"<plugin-name>"}</code>
          </div>
        </div>

        <p class="text-xs text-muted-foreground/60 mt-1">
          Requires Claude Code v2.0.12 or higher.
          <a href="https://github.com/Kamalnrf/claude-plugins" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
            Learn more â†’
          </a>
        </p>
      </section>
    </section>
    <PluginBrowser
      transition:name="search"
      initialPlugins={plugins}
      initialQuery={searchQuery}
      initialHasSkills={hasSkills}
      total={total}
      initialOrderBy={orderBy}
      initialOrder={order}
      client:load
    />
  </div>
</MarketplaceLayout>
